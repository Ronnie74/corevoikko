#!/usr/bin/python
# -*- coding: utf-8 -*-

# Copyright 2008 - 2009 Harri Pitk√§nen (hatapitk@iki.fi)
# Script for automating the build of multiple dictionary variants for
# Voikko. This script should be run in the main directory of
# Suomi-malaga source package.

# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA

import codecs
from subprocess import Popen
from os import access, F_OK
from os import waitpid
from shutil import copyfile, move

def runCmd(cmd):
	p = Popen(cmd, shell=True)
	sts = waitpid(p.pid, 0)
	if sts[1] != 0:
		print u"Error while executing command: " + cmd
		exit(1)

# === Define dictionary properties ===

class Voikkodict:
	idSuffix = u""
	variant = u""
	nameFi = u""
	nameEn = u""
	smOptions = u""

allDicts = []

d = Voikkodict()
d.idSuffix = u""
d.variant = u"standard"
d.nameFi = u"perussanasto"
d.nameEn = u"basic vocabulary"
d.smOptions = u""
allDicts.append(d)

d = Voikkodict()
d.idSuffix = u"-erityis"
d.variant = u"science"
d.nameFi = u"tieteellinen sanasto"
d.nameEn = u"scientific vocabulary"
d.smOptions = u'GENLEX_OPTS="--extra-usage=it,medicine,science,education" EXTRA_LEX=vocabulary/erikoisalat/atk-lyhenteet.lex'
allDicts.append(d)

d = Voikkodict()
d.idSuffix = u"-murre"
d.variant = u"dialects"
d.nameFi = u"murresanasto"
d.nameEn = u"Finnish dialects"
d.smOptions = u'GENLEX_OPTS="--style=dialect,old,international,foreign --min-frequency=10" VANHAT_MUODOT=yes'
allDicts.append(d)

d = Voikkodict()
d.idSuffix = u"-kasvatus"
d.variant = u"education"
d.nameFi = u"kasvatustieteen sanasto"
d.nameEn = u"education vocabulary"
d.smOptions = u'GENLEX_OPTS="--extra-usage=education"'
allDicts.append(d)

WORK_DIR="build"

# === Phase 1: build the dictionaries ===

DICT_DIR_PREFIX="dict"

for dict in allDicts:
	runCmd('make clean')
	runCmd('make voikko-install DESTDIR="' + WORK_DIR + '/' + DICT_DIR_PREFIX
	                                       + dict.idSuffix + '" '
	       + dict.smOptions
	       + ' VOIKKO_VARIANT=' + dict.variant
	       + ' VOIKKO_DESCRIPTION="' + d.nameFi + '"')

# === Phase 2: build oxt packages ===

OXT_TEMPLATE_DIR="oxt-template"
OXT_PACKAGE_DIR="oxt"
DICT_FILES_TO_COPY=[
	'voikko-fi_FI.lex_l',
	'voikko-fi_FI.mor_l',
	'voikko-fi_FI.sym_l',
	'voikko-fi_FI.pro'
]
OXT_DESCRIPTION="description.xml"

oxtdir = WORK_DIR + '/' + OXT_TEMPLATE_DIR + '/'
if access(oxtdir + OXT_DESCRIPTION, F_OK):
	for dict in allDicts:
		for dictFile in DICT_FILES_TO_COPY:
			copyfile(WORK_DIR + '/' + DICT_DIR_PREFIX + dict.idSuffix + '/' + dictFile,
			         oxtdir + dictFile)
		descIn = codecs.open(oxtdir + OXT_DESCRIPTION, "r", "UTF-8")
		descOut = codecs.open(oxtdir + OXT_DESCRIPTION + ".new", "w", "UTF-8")
		line = descIn.readline()
		while (line != u""):
			descOut.write(line)
			if (line.find(u"<display-name>") >= 0):
				descIn.readline()
				descOut.write(u'    <name lang="en-US">Voikko - %s</name>\n' % dict.nameEn)
				descIn.readline()
				descOut.write(u'    <name lang="fi">Voikko - %s</name>\n' % dict.nameFi)
			line = descIn.readline()
		descIn.close()
		descOut.close()
		move(oxtdir + OXT_DESCRIPTION + ".new", oxtdir + OXT_DESCRIPTION)
		runCmd('cd ' + oxtdir + ' && zip -r ../voikko' + dict.idSuffix + '.oxt *')

# === Phase 3: build zip packages ===

for dict in allDicts:
	dirName = WORK_DIR + '/' + DICT_DIR_PREFIX + dict.idSuffix
	zipFile = dirName + '.zip'
	runCmd('zip -j ' + zipFile + ' ' + dirName + '/*')
